<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>充值转盘抽奖</title>
    <!--[if (lt IE 8.0)]><link rel="stylesheet" href="http://s6.qhimg.com/static/16754fa9e26300a6/index.css"><![endif]--><!--[if (!IE)|(gte IE 8.0)]><!--><link rel="stylesheet" href="http://s6.qhimg.com/static/d010322d71894283/index_datauri.css"><!--<![endif]-->
    <!--[if (lt IE 8.0)]><link rel="stylesheet" type="text/css" href="http://s8.qhimg.com/static/369dc00cb8168158/zepto.alert.css"><![endif]--><!--[if (!IE)|(gte IE 8.0)]><!--><link rel="stylesheet" type="text/css" href="http://s6.qhimg.com/static/5b6a3123bbfc4482/zepto.alert_datauri.css"><!--<![endif]-->
</head>
<body>
<!--<a href="test.php">测试</a>-->
<section class="layer">
    <div class="pkg">
        <b>5</b>
        <p>
            <span>获得<strong>2.5</strong>元现金红包大奖</span>
        </p>
        <a class="getBt">立即领取</a>
    </div>
</section>



<img src="http://p1.qhimg.com/t0173c9039dd3732c08.png" alt="" class="head" style="width:100%;margin-bottom: -5px">




<div class="turnplate-outer">
    <div class="turnplate">
        <canvas class="item" id="wheelcanvas" width="960" height="960"></canvas>
        <div class="pointer"></div>
    </div>
</div>



<script src="http://s7.qhimg.com/static/f4a81d83232a5c7e/lib/common.js" type="text/javascript" charset="utf-8" ></script>
<script src="http://s7.qhimg.com/static/b40ac3cfcc8e6546/lib/zepto.alert.js" type="text/javascript" charset="utf-8" ></script>
<script src="http://s7.qhimg.com/static/57f243a4a9319de1/lib/awardRotate.js" type="text/javascript" charset="utf-8" ></script>
<script src="http://s0.qhimg.com/static/7f1f24604065272b.js" type="text/javascript" charset="utf-8" ></script>
<!--<script src="http://s7.qhimg.com/static/55ab30f30c786919/index.js" type="text/javascript" charset="utf-8" ></script>-->
<script type="text/javascript" charset="utf-8" >

    var img_url="http://p2.qhimg.com/t01409a5651d99cbc9b.png";
    var AWARD = [
        {title: "现金红包",icon: img_url,amount: "56"},
        {title: "现金红包",icon: img_url,amount: "888"},
        {title: "现金红包",icon: img_url,amount: "500"},
        {title: "现金红包",icon: img_url,amount: "100"},
        {title: "谢谢参与",icon: "http://p1.qhimg.com/t019e96cad0226fba09.png",amount: "0",loseInfo: 1}
    ];
    var turnplate = {
        restaraunts: [], //大转盘奖品名称
        colors: [], //大转盘奖品区块对应背景颜色
        outsideRadius: 427, //大转盘外圆的半径
        textRadius: 225, //大转盘奖品位置距离圆心的距离
        insideRadius: 230, //大转盘内圆的半径
        startAngle: 0, //开始角度
        bRotate: false, //false:停止;ture:旋转
        findIndex: function(amount) {
            for (var i = 0; i < this.restaraunts.length; i++) {
                if (this.restaraunts[i].amount == amount) {
                    return i;
                }
            }
            return turnplate.findIndex(0);//没有对应金额查找谢谢参与
        }
    };
    $(document).ready(function() {
//        $("body").append(document.cookie);
        /*var Qcookie = Cookie.get('Q');
         if (Qcookie) {
         var mtarr = Qcookie.match(/qid=(\d+)/);
         QIHUQID = mtarr[1];
         var state=judgeQid();
         } else {
         login_alert();
         }*/
        //window.location.href="http://yx.360pay.cn/mcz/ws";
        $(".layer").on("touchmove", function(e) {
            e.preventDefault();
        });
        turnplate.restaraunts = AWARD.sort(function(a, b) {
            return Math.random() > .5 ? -1 : 1;
        });
        turnplate.restaraunts.forEach(function(n, i) {
            $('<img>').attr({
                src: n.icon,
                alt: n.title,
                id: 'turnplate-icon-' + i
            }).hide().appendTo('body');
        });
        turnplate.colors = ["#fff4b9", "#ffe38f"];
        //旋转转盘 item:奖品位置; txt：提示语;
        var rotateFn = function(item, txt) {
            var angles = item * (360 / turnplate.restaraunts.length) - (360 / (turnplate.restaraunts.length * 2));
            if (angles < 270) {
                angles = 270 - angles;
            } else {
                angles = 360 - angles + 270;
            }
            $('#wheelcanvas').stopRotate();
            $('#wheelcanvas').rotate({
                angle: 0,
                animateTo: angles + 1800,
                duration: 8000,
                callback: function() {
                    if (!txt.loseInfo) {
                        showPrize(txt);
                    }
                    turnplate.bRotate = !turnplate.bRotate;
                }
            });
        };
        $('.pointer').click(function() {
            /*var sta=judgeQid();
             if(sta!=0){
             return;
             }*/
            if (turnplate.bRotate) return;
            turnplate.bRotate = !turnplate.bRotate;

            var timeoutHandler = setTimeout(function() {
                time_alert('网络连接超时',"alert");
                turnplate.bRotate = false;
            }, 2000);
            $.ajax({
            //    url: '../lottery_jsonp.php?wallet=weishi_pop_lottery'
                url: '../mock/prize.json'
            }).done(function(res) {

                res=JSON.stringify(res);
//                $("body").append(res);
                clearTimeout(timeoutHandler);
                //sava_use_qs(QIHUQID);
                res=JSON.parse(res);
                if (res.errno == -1) {
                    time_alert("用户今天已经参与过活动。","alert");
                    turnplate.bRotate = !turnplate.bRotate;
                } else if(res.errno==0) {

                    var amount = res.amount ? res.amount : 0;
                    var index = turnplate.findIndex(amount);
                    var awardItem = turnplate.restaraunts[index];
                    rotateFn(index + 1, awardItem);
                }else{
                    time_alert("网络异常。","alert");
                }
            }).fail(function(exc) {
                time_alert('网络连接有问题',"alert");
                turnplate.bRotate = !turnplate.bRotate;
            });
        });
    });

    //获取参加状态 0.未参加 1.参加过
    function getJoinSta(QIHUQID) {
        var QIDS = getCookie('use_qs');
        QIDS = QIDS ? QIDS : "";
        if (QIDS) {
            var q_arr = QIDS.split("|");
            var index = q_arr.indexOf(QIHUQID);
            if (index > -1) {
                return 1;
            } else {
                return 0;
            }
        } else {
            return 0;
        }
    };

    function sava_use_qs(qid) {
        var qs = getCookie("use_qs"),
                qs_add;
        if (qs) {
            qs_add = qs + "|" + qid;
        } else {
            qs_add = qid;
        }
        setCookie("use_qs", qs_add, get_time_byday());

        function get_time_byday() {
            function GetDateStr(AddDayCount) {
                var dd = new Date();
                dd.setDate(dd.getDate() + AddDayCount); //获取AddDayCount天后的日期
                var y = dd.getFullYear();
                var m = dd.getMonth() + 1; //获取当前月份的日期
                var d = dd.getDate();
                return y + "-" + m + "-" + d;
            };
            var now_time = +new Date(),
                    tomorrow_time = new Date(GetDateStr(1)).getTime();
            return tomorrow_time - now_time;
        }
    };

    function login_alert() {
        var len=$(".rDialog").size();
        if(len==1){
            return;
        }
        $.dialog({
            content: '登录360账号参与本次活动',
            title: 'alert',
            okText: '跳转登录',
            ok: function() {
                window['AndroidWebview'].login("");
                return false;
            },
            cancel: function() {},
            lock: false
        });
    };

    function time_alert(text,style) {
        var len=$(".rDialog").size();
        if(len==1){
            return;
        }
        $.dialog({
            content: text,
            title: style,
            time: 2000
        });
    };

    function showPrize(txt) {
        $(".getBt").on("touchstart",function(){
            $(".layer").hide();
            time_alert("领取成功,可在钱包中查看","ok");
            setTimeout(function(){
                QihooPay.openPage("手机充值", "http://yx.360pay.cn/mcz/ws#&pageHome");
            },2000);
        });
        var prizeLay = $(".layer");
        prizeLay.find("b").text(txt.amount);
        prizeLay.find("strong").text(txt.amount);
        prizeLay.show();
    };

    function judgeQid() {
        if (QIHUQID) {
            var joinstate = getJoinSta(QIHUQID);
            switch (joinstate) {
                case 0:
                    break;
                case 1:
                    time_alert("您今日已参加过活动。","alert");
                    break;
                default:
                    time_alert("您的网络异常，请重新登录。","alert");
            }
            return joinstate;
        } else {
            login_alert();
            return 2;
        }
    };

    function getCookie(name) {
        var search;
        search = name + "=";
        offset = document.cookie.indexOf(search)
        if (offset != -1) {
            offset += search.length;
            end = document.cookie.indexOf(";", offset);
            if (end == -1)
                end = document.cookie.length;
            return unescape(document.cookie.substring(offset, end));
        } else
            return "";
    };

    function setCookie(name, value, time) {
        time = time || 0; //seconds有值就直接赋值，没有为0，这个根php不一样。
        var expires = "";
        time = time ? time : (60 * 60 * 1000); //不赋值默认为1个小时
        var date = new Date();
        date.setTime(date.getTime() + time);
        expires = "; expires=" + date.toGMTString();
        document.cookie = name + "=" + escape(value) + expires; //转码并赋值
    };
    //页面所有元素加载完毕后执行drawRouletteWheel()方法对转盘进行渲染
    window.onload = function() {
        setTimeout(function(){
            drawRouletteWheel();
        },100)
    };

    function drawRouletteWheel() {

        var canvas = document.getElementById("wheelcanvas");
        if (1) {
            canvas.style.height = $(canvas).width() + 'px';
        }
        if (canvas.getContext) {
            //根据奖品个数计算圆周角度
            var arc = Math.PI / (turnplate.restaraunts.length / 2);
            var ctx = canvas.getContext("2d");
            //在给定矩形内清空一个矩形
            ctx.clearRect(0, 0, 960, 960);
            //strokeStyle 属性设置或返回用于笔触的颜色、渐变或模式
            ctx.strokeStyle = "#FFBE04";
            //font 属性设置或返回画布上文本内容的当前字体属性
            ctx.font = '16px Microsoft YaHei';
            for (var i = 0; i < turnplate.restaraunts.length; i++) {
                var angle = turnplate.startAngle + i * arc;
                ctx.fillStyle = turnplate.colors[i % turnplate.colors.length];
                ctx.beginPath();
                //arc(x,y,r,起始角,结束角,绘制方向) 方法创建弧/曲线（用于创建圆或部分圆）
                ctx.arc(480, 480, turnplate.outsideRadius, angle, angle + arc, false);
                ctx.arc(480, 480, turnplate.insideRadius, angle + arc - 0.05, angle + 0.05, true);
                ctx.stroke();
                ctx.fill();
                //锁画布(为了保存之前的画布状态)
                ctx.save();

                //----绘制奖品开始----
                ctx.fillStyle = "#E5302F";
                var text = turnplate.restaraunts[i];
                var line_height = 17;
                //translate方法重新映射画布上的 (0,0) 位置
                ctx.translate(480 + Math.cos(angle + arc / 2) * turnplate.textRadius, 480 + Math.sin(angle + arc / 2) * turnplate.textRadius);

                //rotate方法旋转当前的绘图
                ctx.rotate(angle + arc / 2 + Math.PI / 2);

                //把当前画布返回（调整）到上一个save()状态之前
                var img = document.getElementById("turnplate-icon-" + i);
                if(!text.loseInfo){
                    img.onload = function() {
                        ctx.drawImage(img, -60,-175,107,147);
                    };
                    ctx.drawImage(img, -60,-175,107,147);
                }else{
                    img.onload = function() {
                        ctx.drawImage(img, -120, -125, 286, 88);
                    };
                    ctx.drawImage(img, -120, -125, 286, 88);
                }

                ctx.restore();
                //----绘制奖品结束----
            }
        }
    }

</script>
</body>
</html>